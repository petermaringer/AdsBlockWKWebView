<!DOCTYPE html>
<html>
<head>
  <meta name="referrer" content="never">
</head>
<body>
  <div id="div">Hello World ;-)</div>
  <script>
  (function () {
    function getRestoreURL(url) {
      if (url.indexOf(document.location.origin + '/errors/error.html') === 0) {
        return url;
      }
      return '/errors/error.html?url=' + escape(url);
    }
    var index = document.location.href.search("history");
    var sessionRestoreComponents = JSON.parse(unescape(document.location.href.substring(index + "history=".length)));
    div.innerHTML += ' ho1';
    var urlList = sessionRestoreComponents['history'];
    var currentPage = sessionRestoreComponents['currentPage'];
    history.replaceState({}, "", getRestoreURL(urlList[0]));
    for (var i = 1; i < urlList.length; i++) {
      history.pushState({}, '', getRestoreURL(urlList[i]));
    }
    div.innerHTML += ' ho2';
    history.go(currentPage);
    
    // Finally, reload the page to trigger the error redirection, which will load the actual URL.
    // For some reason (maybe a WebKit bug?), document.location still points to SessionRestore.html at this point,
    // so wait until the next tick when the location points to the correct index and URL.
    
    setTimeout(function () {
      div.innerHTML += ' ho3';
      webkit.messageHandlers.sessionRestoreMessageHandler.postMessage({ type: "reload" });
    }, 0);
    div.innerHTML += ' ho4';
  })();
  </script>
</body>
</html>
